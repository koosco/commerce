version: '3.8'

# 운영 환경 설정
# 사용: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  prometheus:
    # 운영 환경에서는 리버스 프록시를 통해 접근하므로 포트 노출하지 않음
    # 또는 필요시 특정 IP에만 바인딩
    ports:
      - "127.0.0.1:9090:9090"  # 로컬호스트에만 바인딩
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus-data:/prometheus  # 메트릭 데이터 영구 저장
    command:
      - '--config.file=/etc/prometheus/prometheus.prod.yml'  # 운영 설정 파일 사용
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'  # 운영: 30일 보관
      - '--storage.tsdb.retention.size=50GB'  # 최대 50GB
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--enable-feature=remote-write-receiver'  # k6 메트릭 수신
    environment:
      - TZ=Asia/Seoul
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    ports:
      - "127.0.0.1:3000:3000"  # 로컬호스트에만 바인딩 (Nginx/Traefik를 통해 접근)
    # volumes는 base 파일에서 상속됨
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER}  # 환경 변수로 관리
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD}
      - GF_SERVER_ROOT_URL=https://monitoring.yourdomain.com
      - GF_SECURITY_SECRET_KEY=${GF_SECRET_KEY}
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=${SMTP_HOST}:587
      - GF_SMTP_USER=${SMTP_USER}
      - GF_SMTP_PASSWORD=${SMTP_PASSWORD}
      - GF_SMTP_FROM_ADDRESS=monitoring@yourdomain.com
      - TZ=Asia/Seoul
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 운영 환경에서는 cAdvisor 추가로 컨테이너 메트릭 수집
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "127.0.0.1:8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg
    restart: unless-stopped
    networks:
      - monitoring
