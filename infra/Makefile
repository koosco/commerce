# ===============================
# Infra Í¥ÄÎ¶¨Ïö© Makefile
# ===============================

.DEFAULT_GOAL := help

# -------------------------------
# Help
# -------------------------------
help:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)  Commerce Infrastructure Makefile$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Kafka Í¥ÄÎ¶¨:$(NC)"
	@echo "  make kafka-local               - local Kafka Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë (docker ÏÇ¨Ïö©)"
	@echo "  make kafka-dev                 - dev Kafka Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë (k3d cluster ÏÇ¨Ïö©)"
	@echo "  make kafka-down                - Kafka Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ"
	@echo "  make kafka-logs                - Kafka Î°úÍ∑∏ ÌôïÏù∏"
	@echo "  make kafka-ps                  - Kafka Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú"
	@echo ""
	@echo "$(YELLOW)Kubernetes Í¥ÄÎ¶¨:$(NC)"
	@echo "  make k8s-ns-create             - Namespace ÏÉùÏÑ±"
	@echo "  make k8s-ns-delete             - Namespace ÏÇ≠Ï†ú"
	@echo "  make k8s-status                - Ï†ÑÏ≤¥ ÏÉÅÌÉú ÌôïÏù∏"
	@echo "  make k8s-apply-all             - Î™®Îì† Î¶¨ÏÜåÏä§ Ï†ÅÏö© (common, services, ingress)"
	@echo ""
	@echo "$(YELLOW)Kubernetes Services:$(NC)"
	@echo "  make k8s-services-apply        - ÏÑúÎπÑÏä§ manifest Ï†ÅÏö© (common + services)"
	@echo "  make k8s-services-delete       - ÏÑúÎπÑÏä§ manifest ÏÇ≠Ï†ú"
	@echo ""
	@echo "$(YELLOW)Kubernetes Deployment:$(NC)"
	@echo "  make k8s-start                 - Î™®Îì† ÏÑúÎπÑÏä§ ÏãúÏûë"
	@echo "  make k8s-stop                  - Î™®Îì† ÏÑúÎπÑÏä§ Ï§ëÏßÄ"
	@echo "  make k8s-restart               - Î™®Îì† ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë"
	@echo "  make k8s-scale                 - Ïä§ÏºÄÏùº Ï°∞Ï†ï (REPLICAS=n)"
	@echo "  make k8s-deployments           - Deployment ÏÉÅÌÉú"
	@echo ""
	@echo "$(YELLOW)Kubernetes Ingress:$(NC)"
	@echo "  make k8s-ingress-apply         - Ingress Ï†ÅÏö© (ENV=dev|prod)"
	@echo "  make k8s-ingress-list          - Ingress Î™©Î°ù"
	@echo ""
	@echo "$(YELLOW)Î°úÏª¨ Í∞úÎ∞ú (k3s):$(NC)"
	@echo "  make k8s-traefik-ip            - Traefik IP ÌôïÏù∏"
	@echo "  make k8s-port-forward          - Ìè¨Ìä∏ Ìè¨ÏõåÎî© (PORT=8080)"
	@echo ""
	@echo "$(YELLOW)ÏòàÏ†ú:$(NC)"
	@echo "  make kafka-topics-setup                              # Kafka topics Ï†ÑÏ≤¥ ÏÑ§Ï†ï"
	@echo "  make kafka-topics-describe TOPIC=koosco.order.v1     # Topic ÏÉÅÏÑ∏ Ï†ïÎ≥¥"
	@echo "  make k8s-apply-all ENV=prod                          # Ïö¥ÏòÅ ÌôòÍ≤Ω Î∞∞Ìè¨"
	@echo ""

# -------------------------------
# Variables
# -------------------------------
# Colors
YELLOW = \033[1;33m
GREEN = \033[0;32m
RED = \033[0;31m
NC = \033[0m # No Color

# Kafka
KAFKA_COMPOSE = kafka/docker-compose.yaml
KAFKA_TOPICS_SCRIPT = scripts/kafka-topics-manager.sh
KAFKA_BOOTSTRAP_SERVERS ?= localhost:9092

# Kubernetes
K8S_DIR = k8s
NAMESPACE = commerce
NAMESPACE_FILE = $(K8S_DIR)/namespace.yaml

# Environment (dev or prod)
ENV ?= dev

# Ingress file selection based on environment
ifeq ($(ENV),prod)
    INGRESS_FILE = $(K8S_DIR)/ingress.yaml
else
    INGRESS_FILE = $(K8S_DIR)/ingress-dev.yaml
endif

# Services (all 6 microservices)
SERVICES = auth-service user-service catalog-service inventory-service order-service payment-service

# -------------------------------
# Kafka Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
# -------------------------------
kafka-local:
	docker compose -f $(KAFKA_COMPOSE) down
	KAFKA_PROFILE=local KAFKA_ADVERTISED_HOST=host.docker.internal docker compose -f $(KAFKA_COMPOSE) up -d

kafka-dev:
	docker compose -f $(KAFKA_COMPOSE) down
	KAFKA_PROFILE=dev KAFKA_ADVERTISED_HOST=host.k3d.internal docker compose -f $(KAFKA_COMPOSE) up -d

# -------------------------------
# Kafka Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ
# -------------------------------
kafka-down:
	docker compose -f $(KAFKA_COMPOSE) down

# -------------------------------
# Kafka Î°úÍ∑∏ ÌôïÏù∏
# -------------------------------
kafka-logs:
	docker compose -f $(KAFKA_COMPOSE) logs -f

# -------------------------------
# Kafka ÌÜ†ÌîΩ Î™©Î°ù ÌôïÏù∏
# -------------------------------
kafka-topics:
	docker exec -it kafka-kraft \
		bash -c "/opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092"

# -------------------------------
# Kafka ÌÜ†ÌîΩ ÏÉùÏÑ±
# Ïòà: make kafka-topic-create TOPIC=test-topic
# -------------------------------
kafka-topic-create:
	docker exec -it kafka-kraft \
		bash -c "/opt/kafka/bin/kafka-topics.sh --create --topic $(TOPIC) --bootstrap-server localhost:9092"

# -------------------------------
# Kafka ÌÜ†ÌîΩ ÏÇ≠Ï†ú
# Ïòà: make kafka-topic-delete TOPIC=test-topic
# -------------------------------
kafka-topic-delete:
	docker exec -it kafka-kraft \
		bash -c "/opt/kafka/bin/kafka-topics.sh --delete --topic $(TOPIC) --bootstrap-server localhost:9092"

# -------------------------------
# Kafka Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú
# -------------------------------
kafka-ps:
	docker compose -f $(KAFKA_COMPOSE) ps

# ===============================
# Kubernetes (k8s) Í¥ÄÎ¶¨
# ===============================

# -------------------------------
# Namespace ÏÉùÏÑ±
# -------------------------------
k8s-ns-create:
	kubectl apply -f $(NAMESPACE_FILE)

# -------------------------------
# Namespace ÏÇ≠Ï†ú
# Ï£ºÏùò: ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ ÎÇ¥ Î™®Îì† Î¶¨ÏÜåÏä§Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§
# -------------------------------
k8s-ns-delete:
	@echo "‚ö†Ô∏è  WARNING: This will delete the '$(NAMESPACE)' namespace and ALL its resources!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		kubectl delete namespace $(NAMESPACE); \
	else \
		echo "Cancelled."; \
	fi

# -------------------------------
# Namespace Î™©Î°ù ÌôïÏù∏
# -------------------------------
k8s-ns-list:
	kubectl get namespaces

# -------------------------------
# Namespace ÏÉÅÏÑ∏ Ï†ïÎ≥¥
# -------------------------------
k8s-ns-info:
	kubectl describe namespace $(NAMESPACE)

# -------------------------------
# ÌòÑÏû¨ Ïª®ÌÖçÏä§Ìä∏Î•º Ìï¥Îãπ ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§Î°ú ÏÑ§Ï†ï
# -------------------------------
k8s-ns-switch:
	kubectl config set-context --current --namespace=$(NAMESPACE)

# -------------------------------
# Ingress Ï†ÅÏö©
# Ïòà: make k8s-ingress-apply (Í∏∞Î≥∏ dev)
# Ïòà: make k8s-ingress-apply ENV=prod
# -------------------------------
k8s-ingress-apply:
	@echo "$(YELLOW)Applying $(ENV) ingress...$(NC)"
	kubectl apply -f $(INGRESS_FILE) -n $(NAMESPACE)
	@echo "$(GREEN)‚úì Ingress applied ($(ENV) environment)$(NC)"

# -------------------------------
# Ingress ÏÇ≠Ï†ú (ÌôòÍ≤ΩÎ≥Ñ)
# Ïòà: make k8s-ingress-delete (Í∏∞Î≥∏ dev)
# Ïòà: make k8s-ingress-delete ENV=prod
# -------------------------------
k8s-ingress-delete:
	@echo "$(YELLOW)Deleting $(ENV) ingress...$(NC)"
	kubectl delete -f $(INGRESS_FILE) -n $(NAMESPACE)
	@echo "$(GREEN)‚úì Ingress deleted ($(ENV) environment)$(NC)"

# -------------------------------
# Î™®Îì† Ingress ÏÇ≠Ï†ú
# -------------------------------
k8s-ingress-delete-all:
	kubectl delete ingress --all -n $(NAMESPACE)

# -------------------------------
# Ingress Î™©Î°ù ÌôïÏù∏
# -------------------------------
k8s-ingress-list:
	kubectl get ingress -n $(NAMESPACE)

# -------------------------------
# Ingress ÏÉÅÏÑ∏ Ï†ïÎ≥¥
# Ïòà: make k8s-ingress-describe NAME=commerce-ingress
# -------------------------------
k8s-ingress-describe:
	@if [ -z "$(NAME)" ]; then \
		kubectl describe ingress -n $(NAMESPACE); \
	else \
		kubectl describe ingress $(NAME) -n $(NAMESPACE); \
	fi

# -------------------------------
# Ingress ÏÉÅÏÑ∏ Ï†ïÎ≥¥ (YAML)
# Ïòà: make k8s-ingress-get NAME=commerce-ingress
# -------------------------------
k8s-ingress-get:
	@if [ -z "$(NAME)" ]; then \
		kubectl get ingress -n $(NAMESPACE) -o yaml; \
	else \
		kubectl get ingress $(NAME) -n $(NAMESPACE) -o yaml; \
	fi

# -------------------------------
# Kubernetes Ï†ÑÏ≤¥ ÏÉÅÌÉú ÌôïÏù∏
# -------------------------------
k8s-status:
	@if [ -z "$(resource)" ]; then \
		echo "=== Namespace Status ==="; \
		kubectl get namespace $(NAMESPACE) 2>/dev/null || echo "Namespace '$(NAMESPACE)' does not exist"; \
		echo ""; \
		echo "=== Ingress ==="; \
		kubectl get ingress -n $(NAMESPACE) 2>/dev/null || echo "No ingresses found in namespace '$(NAMESPACE)'"; \
		echo ""; \
		echo "=== Services ==="; \
		kubectl get svc -n $(NAMESPACE) 2>/dev/null || echo "No services found in namespace '$(NAMESPACE)'"; \
		echo ""; \
		echo "=== Pods ==="; \
		kubectl get pods -n $(NAMESPACE) 2>/dev/null || echo "No pods found in namespace '$(NAMESPACE)'"; \
	else \
		if [ "$(resource)" = "namespace" ]; then \
			echo "=== Namespace Status ==="; \
			kubectl get namespace $(NAMESPACE); \
		elif [ "$(resource)" = "ingress" ]; then \
			echo "=== Ingress ==="; \
			kubectl get ingress -n $(NAMESPACE); \
		elif [ "$(resource)" = "svc" ] || [ "$(resource)" = "services" ]; then \
			echo "=== Services ==="; \
			kubectl get svc -n $(NAMESPACE); \
		elif [ "$(resource)" = "pods" ] || [ "$(resource)" = "pod" ]; then \
			echo "=== Pods ==="; \
			kubectl get pods -n $(NAMESPACE); \
		else \
			echo "Unknown resource: $(resource). Available: namespace | ingress | svc | pods"; \
		fi \
	fi


# -------------------------------
# Ï†ÑÏ≤¥ k8s Î¶¨ÏÜåÏä§ Ï†ÅÏö©
# Ïòà: make k8s-apply-all (Í∏∞Î≥∏ dev)
# Ïòà: make k8s-apply-all ENV=prod
# -------------------------------
k8s-apply-all:
	@echo "$(YELLOW)Applying all k8s resources ($(ENV) environment)...$(NC)"
	kubectl apply -f $(NAMESPACE_FILE)
	kubectl apply -f $(K8S_DIR)/common/ -n $(NAMESPACE)
	kubectl apply -f $(K8S_DIR)/services/ -n $(NAMESPACE)
	kubectl apply -f $(INGRESS_FILE) -n $(NAMESPACE)
	@echo "$(GREEN)‚úì All resources applied$(NC)"

# -------------------------------
# ÏÑúÎπÑÏä§ manifest Ï†ÅÏö© (common + services)
# -------------------------------
k8s-services-apply:
	@echo "$(YELLOW)Applying service manifests...$(NC)"
	kubectl apply -f $(K8S_DIR)/common/ -n $(NAMESPACE)
	kubectl apply -f $(K8S_DIR)/services/ -n $(NAMESPACE)
	@echo "$(GREEN)‚úì Service manifests applied$(NC)"

# -------------------------------
# ÏÑúÎπÑÏä§ manifest ÏÇ≠Ï†ú
# -------------------------------
k8s-services-delete:
	@echo "$(YELLOW)Deleting service manifests...$(NC)"
	kubectl delete -f $(K8S_DIR)/services/ -n $(NAMESPACE) --ignore-not-found
	kubectl delete -f $(K8S_DIR)/common/ -n $(NAMESPACE) --ignore-not-found
	@echo "$(GREEN)‚úì Service manifests deleted$(NC)"

# ===============================
# Kubernetes Deployment Í¥ÄÎ¶¨
# ===============================

# -------------------------------
# Î™®Îì† ÏÑúÎπÑÏä§ Ï§ëÏßÄ (replicas=0)
# Ï∞∏Í≥†: Ïô∏Î∂Ä DB ÏÇ¨Ïö©ÏúºÎ°ú MariaDB deployment Ï†úÍ±∞
# -------------------------------
k8s-stop:
	@echo "$(YELLOW)Stopping all services (scaling to 0)...$(NC)"
	@echo ""
	@for deploy in auth-service user-service catalog-service inventory-service order-service payment-service; do \
		replicas=$$(kubectl get deployment/$$deploy -n $(NAMESPACE) -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0"); \
		if [ "$$replicas" = "0" ]; then \
			echo "  $(YELLOW)‚äò$(NC) $$deploy: already stopped (replicas=0)"; \
		else \
			echo "  $(GREEN)‚Üí$(NC) $$deploy: stopping (replicas=$$replicas ‚Üí 0)"; \
			kubectl scale deployment/$$deploy -n $(NAMESPACE) --replicas=0 2>/dev/null || echo "  $(RED)‚úó$(NC) $$deploy: not found"; \
		fi \
	done
	@echo ""
	@echo "$(GREEN)‚úì Stop operation complete$(NC)"

# -------------------------------
# Î™®Îì† ÏÑúÎπÑÏä§ ÏãúÏûë
# Ï∞∏Í≥†: Ïô∏Î∂Ä DB ÏÇ¨Ïö©ÏúºÎ°ú MariaDB deployment Ï†úÍ±∞
# -------------------------------
k8s-start:
	@echo "$(YELLOW)Starting all services...$(NC)"
	@echo ""
	@for deploy in auth-service user-service catalog-service inventory-service order-service payment-service; do \
		target=2; \
		replicas=$$(kubectl get deployment/$$deploy -n $(NAMESPACE) -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0"); \
		if [ "$$replicas" = "$$target" ]; then \
			echo "  $(YELLOW)‚äò$(NC) $$deploy: already running (replicas=$$target)"; \
		else \
			echo "  $(GREEN)‚Üí$(NC) $$deploy: starting (replicas=$$replicas ‚Üí $$target)"; \
			kubectl scale deployment/$$deploy -n $(NAMESPACE) --replicas=$$target 2>/dev/null || echo "  $(RED)‚úó$(NC) $$deploy: not found"; \
		fi \
	done
	@echo ""
	@echo "$(GREEN)‚úì Start operation complete$(NC)"

# -------------------------------
# Î™®Îì† ÏÑúÎπÑÏä§ Ïä§ÏºÄÏùº Ï°∞Ï†ï
# Ïòà: make k8s-scale REPLICAS=3
# -------------------------------
k8s-scale:
	@if [ -z "$(REPLICAS)" ]; then \
		echo "$(RED)Error: REPLICAS not specified$(NC)"; \
		echo "Usage: make k8s-scale REPLICAS=3"; \
		exit 1; \
	fi
	@echo "$(YELLOW)Scaling all services to $(REPLICAS) replicas...$(NC)"
	@kubectl scale deployment/auth-service -n $(NAMESPACE) --replicas=$(REPLICAS)
	@kubectl scale deployment/user-service -n $(NAMESPACE) --replicas=$(REPLICAS)
	@kubectl scale deployment/catalog-service -n $(NAMESPACE) --replicas=$(REPLICAS)
	@kubectl scale deployment/inventory-service -n $(NAMESPACE) --replicas=$(REPLICAS)
	@kubectl scale deployment/order-service -n $(NAMESPACE) --replicas=$(REPLICAS)
	@kubectl scale deployment/payment-service -n $(NAMESPACE) --replicas=$(REPLICAS)
	@echo "$(GREEN)‚úì All services scaled to $(REPLICAS) replicas$(NC)"

# -------------------------------
# Î™®Îì† ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë
# -------------------------------
k8s-restart:
	@echo "$(YELLOW)Restarting all services...$(NC)"
	@kubectl rollout restart deployment/auth-service -n $(NAMESPACE)
	@kubectl rollout restart deployment/user-service -n $(NAMESPACE)
	@kubectl rollout restart deployment/catalog-service -n $(NAMESPACE)
	@kubectl rollout restart deployment/inventory-service -n $(NAMESPACE)
	@kubectl rollout restart deployment/order-service -n $(NAMESPACE)
	@kubectl rollout restart deployment/payment-service -n $(NAMESPACE)
	@echo "$(GREEN)‚úì All services restarted$(NC)"

# -------------------------------
# Deployment ÏÉÅÌÉú ÌôïÏù∏
# -------------------------------
k8s-deployments:
	@echo "$(YELLOW)=== Deployments Status ===$(NC)"
	@kubectl get deployments -n $(NAMESPACE)
	@echo ""
	@echo "$(YELLOW)=== Pods Status ===$(NC)"
	@kubectl get pods -n $(NAMESPACE)

# -------------------------------
# ÌäπÏ†ï ÏÑúÎπÑÏä§ Ïä§ÏºÄÏùº Ï°∞Ï†ï
# Ïòà: make k8s-scale-service SERVICE=catalog-service REPLICAS=3
# -------------------------------
k8s-scale-service:
	@if [ -z "$(SERVICE)" ] || [ -z "$(REPLICAS)" ]; then \
		echo "$(RED)Error: SERVICE and REPLICAS are required$(NC)"; \
		echo "Usage: make k8s-scale-service SERVICE=catalog-service REPLICAS=3"; \
		exit 1; \
	fi
	@echo "$(YELLOW)Scaling $(SERVICE) to $(REPLICAS) replicas...$(NC)"
	@kubectl scale deployment/$(SERVICE) -n $(NAMESPACE) --replicas=$(REPLICAS)
	@echo "$(GREEN)‚úì $(SERVICE) scaled to $(REPLICAS) replicas$(NC)"

# ===============================
# Î°úÏª¨ Í∞úÎ∞ú (k3s)
# ===============================

# -------------------------------
# Traefik IP Î∞è Ï†ëÍ∑º Ï†ïÎ≥¥ ÌôïÏù∏
# -------------------------------
k8s-traefik-ip:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)  Traefik LoadBalancer Info$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@kubectl get svc traefik -n kube-system
	@echo ""
	@echo "$(YELLOW)‚úì Access URLs:$(NC)"
	@echo "  External IP: http://$$(kubectl get svc traefik -n kube-system -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
	@echo "  NodePort:    http://localhost:$$(kubectl get svc traefik -n kube-system -o jsonpath='{.spec.ports[0].nodePort}')"
	@echo ""
	@echo "$(YELLOW)üí° Tip: Use 'make k8s-port-forward' for localhost:80$(NC)"

# -------------------------------
# localhost Ìè¨Ìä∏ Ìè¨ÏõåÎî© (Í∞úÎ∞úÏö©)
# Í∏∞Î≥∏: 8080 Ìè¨Ìä∏ (Í∂åÌïú Î∂àÌïÑÏöî)
# Ïòà: make k8s-port-forward
# Ïòà: make k8s-port-forward PORT=3000
# Ïòà: make k8s-port-forward PORT=80 (sudo ÌïÑÏöî)
# -------------------------------
PORT ?= 8080

k8s-port-forward:
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)  Port Forwarding: localhost:$(PORT)$(NC)"
	@echo "$(GREEN)========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)‚úì Services available at:$(NC)"
	@echo "  - http://localhost:$(PORT)/api/users"
	@echo "  - http://localhost:$(PORT)/api/auth"
	@echo "  - http://localhost:$(PORT)/api/catalog"
	@echo "  - http://localhost:$(PORT)/api/orders"
	@echo ""
	@if [ "$(PORT)" -lt "1024" ]; then \
		echo "$(RED)‚ö† Port $(PORT) requires sudo (privileged port)$(NC)"; \
		echo "$(YELLOW)Run: sudo make k8s-port-forward PORT=$(PORT)$(NC)"; \
		echo "$(YELLOW)Or use: make k8s-port-forward PORT=8080$(NC)"; \
		echo ""; \
	fi
	@echo "$(YELLOW)Press Ctrl+C to stop$(NC)"
	@echo ""
	kubectl port-forward -n kube-system svc/traefik $(PORT):80

.PHONY: help \
	kafka-local kafka-dev kafka-down kafka-logs kafka-topics kafka-topic-create kafka-topic-delete kafka-ps \
	k8s-ns-create k8s-ns-delete k8s-ns-list k8s-ns-info k8s-ns-switch \
	k8s-ingress-apply k8s-ingress-delete k8s-ingress-delete-all \
	k8s-ingress-list k8s-ingress-describe k8s-ingress-get \
	k8s-status k8s-apply-all k8s-services-apply k8s-services-delete \
	k8s-stop k8s-start k8s-scale k8s-restart k8s-deployments k8s-scale-service \
	k8s-traefik-ip k8s-port-forward
